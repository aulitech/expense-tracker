<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="AULI.TECH Sensor Streaming">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="icon.png">
    <link rel="stylesheet" href="../styles/main.css">
    <title>Web Bluetooth / Notifications Sample</title>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
        import { getFirestore } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
        apiKey: "AIzaSyANo1eESWXTEumIdvcvOV2cat1ZGbyrhvg",
        authDomain: "sk-exp.firebaseapp.com",
        projectId: "sk-exp",
        storageBucket: "sk-exp.firebasestorage.app",
        messagingSenderId: "772476640334",
        appId: "1:772476640334:web:44f8a8bd36dc93f66b371f",
        measurementId: "G-S2D53Z2B6Z"
        };

        // Initialize Firebase and Firestore
        const app = initializeApp(firebaseConfig);
        const firestore = getFirestore(app);

        // Function to save data to Firestore
        window.saveData = function() {
            const userName = document.getElementById("userName").value || "Unknown";
            const now = new Date();
            const formattedDate = now.toISOString().replace(/T/, '_').replace(/:/g, '-').split('.')[0];

            let gestureData = [];
            dataArray.forEach(function(rowArray) {
                let dataObject = {
                    GestureNumber: rowArray[0],
                    ExpectedIndex: rowArray[1],
                    NotificationIndex: rowArray[2],
                    Timestamp: rowArray[3],
                    Ax: rowArray[4],
                    Ay: rowArray[5],
                    Az: rowArray[6],
                    Gx: rowArray[7],
                    Gy: rowArray[8],
                    Gz: rowArray[9],
                    GestureLabel: rowArray[10],
                    GestureName: rowArray[11],
                    CatoLocation: rowArray[12],
                    Disability: rowArray[13],
                    AppVersion: rowArray[14]
                };
                gestureData.push(dataObject);
            });

            // Save data to Firestore
            firestore.collection('gestureData').doc(userName + '_' + formattedDate).set({
                userName: userName,
                date: formattedDate,
                gestures: gestureData
            })
            .then(() => {
                console.log('Data successfully saved to Firestore.');
            })
            .catch((error) => {
                console.error('Error saving data to Firestore:', error);
            });
        };
    </script>

    <script>
        // Add a global error event listener early on in the page load, to help ensure that browsers
        // which don't support specific functionality still end up displaying a meaningful message.
        window.addEventListener('error', function (error) {
            if (ChromeSamples && ChromeSamples.setStatus) {
                console.error(error);
                ChromeSamples.setStatus(error.message + ' (Your browser may not support this feature.)');
                error.preventDefault();
            }
        });
    </script>

</head>

<style>
    .pageIcon {
        width: 100px;
        height: 100px;
        margin: 0 auto;
        display: block;
    }

    .output {
        border: 1px solid #ccc;
        padding: 10px;
        margin: 10px 0;
        max-height: 80vh;
        height: 80vh;
        overflow: auto;
    }

    .scroll {
        max-height: 50vh;
        height: 50vh;
        overflow: auto;
        display: flex;
        flex-direction: column-reverse;
        border: rgb(0, 0, 0) 3px solid;
    }

    body {
    font-family: 'Calibri', sans-serif;
    }

    #log {
        font-family: monospace;
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    button {
        margin: 10px;
        background-color: hsl(60, 83%, 68%); /* Light yellow */
        border: none; /* Optional: remove border */
        padding: 10px 20px; /* Optional: add some padding */
        cursor: pointer; /* Change cursor to pointer on hover */
        font-size: 16px; /* Optional: set font size */
    }

    button:hover {
        background-color: #ffe4b5; /* Lighter shade on hover */
    }

    .buttons {
        margin: 10px;
        display: flex;
        flex-direction: row;
        justify-content: center;
        margin: 10px;
    }

    .accept-reject {
        margin-top: 20px; /* Add some spacing above this row */
        display: flex;
        flex-direction: row;
        justify-content: center;
    }

    .inputs {
        display: flex;
        justify-content: space-around;
        margin: 10px;
        border: none;
        font-size: 16px; /* Optional: set font size */
        padding: 10px 20px; /* Optional: add some padding */
        background-color: lightgrey;
    }

    .progress-container {
    width: 100%;
    background-color: lightgray;
    height: 20px;
    margin: 10px auto;
    border-radius: 10px;
    }

    .progress-bar {
    width: 100%;
    height: 100%;
    background-color: #66c666;
    border-radius: 10px;
    }

    h1 {
        text-align: center;
    }

    h3 {
        text-align: center;
    }

    p {
        text-align: center;
    }
</style>

<body>
    <h1>Cato Gesture Collection</h1>

    <div id="acceptedCountBox" style="text-align: center; margin-bottom: 20px;">
        <h3>Accepted Gesture Count: <span id="acceptedGestureCount">0</span></h3>
    </div>

    <div class="inputs">
        <div>
            <label for="userName">User Name</label>
            <input type="text" id="userName" >
        </div>

        <div>
            <label for="gesture">Gesture ID</label>
            <input type="number" id="gesture" placeholder="Integer label (e.g. 1, 2, etc)" step="1">
        </div>

        <div>
            <label for="gestureName">Gesture Name</label>
            <input type="text" id="gestureName" placeholder="e.g. Nod right, hand wave">
        </div>

        <div>
            <label for="location">Cato Location</label>
            <select id="location">
                <option value="Head">Head</option>
                <option value="Hand">Hand</option>
                <option value="Foot">Foot</option>
                <option value="Toe">Toe</option>
                <option value="Ankle">Ankle</option>
                <option value="Heel">Heel</option>
                <option value="Calf">Calf</option>
                <option value="Thigh">Thigh</option>
            </select>
        </div>

        <div>
            <label for="disability">Disability</label>
            <input type="text" id="disability" placeholder="e.g. None, ALS">
        </div>

        <div>
            <label for="timeoutDuration">Gesture Duration (sec)</label>
            <input type="number" id="timeoutDuration" >
        </div>

    </div>

    <div class="buttons">
        <button onclick="onEnableButtonClick()" id="enableMotion">Connect Cato</button>
        <button disabled onclick="onStartButtonClick()" id="startNotifications">Start</button>
        <button disabled onclick="onStopButtonClick()" id="stopNotifications">Stop</button>
        <button disabled id="saveData" onclick="saveData()">Download Gesture Data</button>
    </div>

    <div class="buttons accept-reject">
        <button id="acceptGesture" style="display:none;" onclick="acceptGesture()">Accept Gesture</button>
        <button id="rejectGesture" style="display:none;" onclick="rejectGesture()">Reject Gesture</button>
    </div>

    <div class="progress-container">
        <div class="progress-bar" id="progressBar"></div>
    </div>
    


    <div id="output" class="output">
        <div id="content"></div>
        <div id="status">
            <p>Expected Notifications:
                <span id="expectedNotifications">0</span>
                <span>received Notifications: </span>
                <span id="receivedNotifications">0</span>
            </p>
        </div>
        <div class="scroll">
            <div id="log"></div>
        </div>
    </div>

    

    <script>
        const motionService = "01912446-e5aa-9ee9-0e19-000e7e57049c"
        const accelerometerCharacteristic = "00800000-0001-11e1-ac36-0002a5d5c51b"
        const enableCharacteristic = "00001524-1212-efde-1523-785feabcd123"

        var myDevice
        var myService
        var enable
        var acc

        var alignedData = { 0: { ts: 0, acc: [0, 0, 0], gyro: [0, 0, 0] } }

        function onEnableButtonClick() {

            /*
            // We should have a filter to only show AULI.TECH devices of the right type (0x01)
            // We Need cato to advertise mfgData with 0x01 as the first byte

            navigator.bluetooth.requestDevice({
            filters: [{
                manufacturerData: [{
                companyIdentifier: AULI.TECH_COMPANY_IDENTIFIER,
                dataPrefix: new Uint8Array([0x01])
                }]
            }],
            optionalServices: [motionService] // Required to access service later.
            })*/

            if (myDevice) {
                log('Disconnecting ' + myDevice.name);
                myDevice.gatt.disconnect()
                    .then(_ => {
                        log('Disconnect sent.');
                    })
                    .catch(error => {
                        log('Argh! ' + error);
                    });
                return
            }

            log('Looking for devices');
            navigator.bluetooth.requestDevice({ acceptAllDevices: true, optionalServices: [motionService] })

                .then(device => {
                    myDevice = device;
                    // Set up event listener for when device gets disconnected.
                    myDevice.addEventListener('gattserverdisconnected', onDisconnected);
                    log('Connecting to GATT Server...');
                    return device.gatt.connect();
                })
                .then(server => {
                    document.querySelector('#enableMotion').textContent = 'Disconnect';
                    log('Getting Motion Service...');
                    return server.getPrimaryService(motionService);
                })
                .then(service => {
                    myService = service;
                    log('Getting EnableCharacteristic...');
                    return service.getCharacteristic(enableCharacteristic);
                })
                .then(characteristic => {
                    enable = characteristic;
                    log('Getting Acc... ');
                    return myService.getCharacteristic(accelerometerCharacteristic);
                })
                .then(characteristic => {
                    acc = characteristic;
                    log('Got All')
                })

                .catch(error => {
                    log('Argh! ' + error);
                    return
                });

        }

        let notificationsRcvd = 0
        let dataArray = [];
        let currentSessionData = [];
        let acceptedGestureCount = 0;

        // Input field validation 
        function validateInputs() {
            const userName = document.getElementById("userName").value;
            const gesture = document.getElementById("gesture").value;
            const gestureName = document.getElementById("gestureName").value;
            const location = document.getElementById("location").value;
            const disability = document.getElementById("disability").value;
            const timeoutDuration = document.getElementById("timeoutDuration").value;

            // Check if all fields have values
            if (userName && gesture && gestureName && location && disability && timeoutDuration) {
                document.getElementById('startNotifications').removeAttribute('disabled');
            } else {
                document.getElementById('startNotifications').setAttribute('disabled', 'disabled');
            }
        }

        document.getElementById("userName").addEventListener('input', validateInputs);
        document.getElementById("gesture").addEventListener('input', validateInputs);
        document.getElementById("gestureName").addEventListener('input', validateInputs);
        document.getElementById("location").addEventListener('change', validateInputs);
        document.getElementById("disability").addEventListener('input', validateInputs);
        document.getElementById("timeoutDuration").addEventListener('input', validateInputs);

        let progressInterval;
        function onStartButtonClick() {
            const timeoutDuration = parseInt(document.getElementById('timeoutDuration').value) || 2;  // Default to 2 seconds if no input
            if (enable) {
                enable.writeValue(new Uint8Array([0x01]))
                    .then(_ => {
                        log('Enabling Cato Motion service.');
                    })
                    .catch(error => {
                        log('Argh! ' + error);
                        return
                    });
            } else {
                log('No enable characteristic found');
                return
            }

            if (acc) {
                acc.startNotifications()
                    .then(_ => {
                        log('Notifications requested');
                        acc.addEventListener('characteristicvaluechanged', handleNotifications);
                        document.querySelector('#stopNotifications').removeAttribute('disabled')
                        document.querySelector('#startNotifications').setAttribute('disabled', 'disabled')
                        notificationsRcvd = 0
                        currentSessionData = []; // Clear current session data on start

                        // Start progress bar animation and auto-stop logic
                        const progressBar = document.getElementById('progressBar');
                        progressBar.style.width = '100%';  // Set to full width initially
                        let progress = 100;  // 100% width initially
                        const intervalDuration = timeoutDuration * 1000 / 20;

                        if (progressInterval) {
                            clearInterval(progressInterval);
                        }

                        progressInterval = setInterval(() => {
                            progress -= 5;  // Decrease progress by 5% (20 steps total)
                            progressBar.style.width = progress + '%';  // Update the width of the bar

                            if (progress <= 0) {
                                clearInterval(progressInterval);  // Stop the interval when the bar is empty
                                onStopButtonClick();  // Automatically stop notifications
                            }
                        }, intervalDuration);  // Adjust the interval based on the user-specified duration
                    })
                    .catch(error => {
                        log('Argh! ' + error);
                    });
            } else {
                log('No accelerometer characteristic found');
                return
            }
        }


        function onStopButtonClick() {
            if (acc) {
                acc.stopNotifications()
                    .then(_ => {
                        log('Notifications stopped');
                        acc.removeEventListener('characteristicvaluechanged', handleNotifications);

                        // Disable Start and Stop buttons when Accept/Reject buttons appear
                        document.querySelector('#startNotifications').setAttribute('disabled', 'disabled');
                        document.querySelector('#stopNotifications').setAttribute('disabled', 'disabled');

                        // Show Accept/Reject buttons after stop
                        document.getElementById('acceptGesture').style.display = 'inline-block';
                        document.getElementById('rejectGesture').style.display = 'inline-block';

                         // Reset the progress bar
                        const progressBar = document.getElementById('progressBar');
                        progressBar.style.width = '100%';  // Reset the bar to full width
                        clearInterval(progressInterval);
                    })
                    .catch(error => {
                        log('Argh! ' + error);
                    });
            }

            if (enable) {
                enable.writeValue(new Uint8Array([0x00]))
                    .then(_ => {
                        log('Disabling Cato Motion service');
                    })
                    .catch(error => {
                        log('Argh! ' + error);
                        return
                    });
            }
        }


        function handleNotifications(event) {
            let value = event.target.value;

            const seq = value.getUint16(0, false)
            const ts = value.getUint16(2, false)


            const ax = value.getInt16(4, false) / 10
            const ay = value.getInt16(6, false) / 10
            const az = value.getInt16(8, false) / 10


            const gx = value.getInt16(10, false) / 10
            const gy = value.getInt16(12, false) / 10
            const gz = value.getInt16(14, false) / 10

            const gestureType = document.getElementById("gesture").value || "0";
            const gestureName = document.getElementById("gestureName").value || "Unknown";
            const location = document.getElementById("location").value || "Unknown";
            const disability = document.getElementById("disability").value || "Unknown";
            const version = "0.0.1"

            let dataRow = [acceptedGestureCount, notificationsRcvd, seq, ts, ax, ay, az, gx, gy, gz, gestureType, gestureName, location, disability, version];
            notificationsRcvd++;
            dataArray.push(dataRow);
            currentSessionData.push(dataRow);



            document.querySelector('#saveData').removeAttribute('disabled');

            //alignedData[seq] = { ts: ts, acc: [ax, ay, az], gyro: [gx, gy, gz] }

            //log('Data: [' + seq + '] ' + JSON.stringify(alignedData[seq]))
            setStatus(seq, notificationsRcvd)

        }

        function acceptGesture() {
            // Hide Accept/Reject buttons
            acceptedGestureCount++;
            document.getElementById('acceptedGestureCount').textContent = acceptedGestureCount;

            document.getElementById('startNotifications').removeAttribute('disabled');
            document.querySelector('#stopNotifications').setAttribute('disabled', 'disabled');

            document.getElementById('acceptGesture').style.display = 'none';
            document.getElementById('rejectGesture').style.display = 'none';
            log('Gesture Accepted');
        }

        
        function rejectGesture() {
            // Remove the last session's data from the main dataArray
            dataArray = dataArray.slice(0, dataArray.length - currentSessionData.length);
            currentSessionData = []; // Clear current session data

            document.getElementById('startNotifications').removeAttribute('disabled');
            document.querySelector('#stopNotifications').setAttribute('disabled', 'disabled');

            // Hide Accept/Reject buttons
            document.getElementById('acceptGesture').style.display = 'none';
            document.getElementById('rejectGesture').style.display = 'none';
            log('Gesture Rejected');
        }
   

        function onDisconnected() {
            log('Device disconnected');
            //myDevice.removeEventListener('gattserverdisconnected', onDisconnected);

            document.querySelector('#enableMotion').textContent = 'Connect';
            document.querySelector('#startNotifications').setAttribute('disabled', 'disabled')
            document.querySelector('#stopNotifications').setAttribute('disabled', 'disabled')
            myDevice = null;
        }

        function isWebBluetoothEnabled() {
            if (navigator.bluetooth) {
                return true;
            } else {
                ChromeSamples.setStatus('Web Bluetooth API is not available.\n' +
                    'Please make sure the "Experimental Web Platform features" flag is enabled.');
                return false;
            }
        }

        const expectedNotifications = document.querySelector('#expectedNotifications')
        const receivedNotifications = document.querySelector('#receivedNotifications')

        var ChromeSamples = {
            log: function () {
                var line = Array.prototype.slice.call(arguments).map(function (argument) {
                    return typeof argument === 'string' ? argument : JSON.stringify(argument);
                }).join(' ');

                document.querySelector('#log').textContent += line + '\n';
                console.log(line)
            },

            clearLog: function () {
                document.querySelector('#log').textContent = '';
            },

            setStatus: function (exp,rec) {
                expectedNotifications.textContent = exp;
                receivedNotifications.textContent = rec
            },

            setContent: function (newContent) {
                var content = document.querySelector('#content');
                while (content.hasChildNodes()) {
                    content.removeChild(content.lastChild);
                }
                content.appendChild(newContent);
            }
        };

        if (/Chrome\/(\d+\.\d+.\d+.\d+)/.test(navigator.userAgent)) {
            // Let's log a warning if the sample is not supposed to execute on this
            // version of Chrome.
            if (48 > parseInt(RegExp.$1)) {
                ChromeSamples.setStatus('Warning! Keep in mind this sample has been tested with Chrome ' + 48 + '.');
            }
        }

        log = ChromeSamples.log;
        setStatus = ChromeSamples.setStatus;

    </script>
</body>

</html>